# Sales Intelligence System — Project Context
# Last updated: 2026-02-18

## Project Vision
Build a smart agentic sales intelligence platform for Onsite Teams (Construction SaaS).
Help sales team with real-time alerts, performance tracking, and actionable insights.

## Architecture
- Frontend: Next.js 16 (App Router) on port 3000
- Backend: FastAPI on port 8000
- Database: Supabase (PostgreSQL) — free tier (500MB)
- Auth: Supabase Auth + JWT (local decode in backend)
- API: Frontend calls backend directly (http://localhost:8000/api) bypassing Next.js proxy

## Data Flow
1. CSV upload (Zoho CRM export) → client-side parse for instant display
2. Backend computes summary + agent profiles → saves to Supabase
3. On refresh → loads pre-computed summary from Supabase (fast, ~1-2MB)
4. Future: Zoho webhooks for real-time lead updates (not implemented yet)

## Key Decisions
- DO NOT store 300K raw leads in Supabase (free tier limit)
- Store only pre-computed summaries (~1-2MB) and agent profiles
- Revenue only counted from actual sales (sale_done=1), not all leads
- Parse "Rs. 42,000.00" currency format from Zoho exports
- Leads page is placeholder until Zoho webhook integration
- Deal Owner is the primary field (not Lead Owner) for all analytics

## Database Tables
- dashboard_summary: single row with JSONB columns (kpis, charts, insights, sales_data, etc.)
- agent_profiles: per-deal-owner performance profiles with notes
- users: app users (linked to Supabase Auth)
- alerts, leads, briefs: future use (Zoho integration)

## Known Issues / Tech Debt
- [ ] Supabase user lookup: auth_id returns 400, id returns 406 (only email works)
- [ ] Hydration mismatch warning (browser extension related, harmless)
- [ ] sw.js 404 spam in console (no service worker registered)
- [ ] Leads page empty until Zoho integration
- [ ] Dashboard home shows 0s until Zoho integration

## Completed Features
- [x] Auth: Supabase login/session persistence, JWT decode
- [x] Intelligence Dashboard: 8 tabs (Sales, Overview, Pipeline, Team, Sources, Aging, Trends, Deep Dive)
- [x] Sales Tab: Revenue KPIs, monthly trend, region/source/owner analysis, dual leaderboards (by count + revenue)
- [x] Agent Profiles: auto-computed per deal owner with performance, patterns, strengths, concerns, monthly trends, notes
- [x] Revenue parsing: handles "Rs. 42,000.00" format
- [x] Data persistence: summary + agent profiles saved to Supabase
- [x] Direct API calls (bypass Next.js proxy to fix auth header stripping)
- [x] FastAPI redirect_slashes=False (fix 307 auth loop)

## Completed — Smart Alert Agent
- [x] Smart Alert Agent: auto-generates alerts on CSV upload
- [x] 10 alert rules: stale leads, demo dropout, low conversion, hot prospects,
      priority overload, inactive agents, top performer, revenue milestone,
      pipeline risk, follow-up needed
- [x] Severity levels: critical, high, medium, info
- [x] Beautiful alert cards with icons, severity colors, agent names
- [x] Mark as read, filter by severity
- [x] Alerts saved to Supabase, persist across sessions
- [x] save_alerts uses base columns only (works with or without migration 007); frontend normalizes message/sent_at when severity/title missing

## Completed — Access & deal-owner scoping
- [x] users.deal_owner_name: admin sets which deal owner(s) a rep sees (exact match to CSV deal_owner)
- [x] dashboard_summary.summary_by_owner: per-owner summary on upload; reps get only their summary
- [x] GET /intelligence/summary: managers/admins get full summary; reps get summary_by_owner[deal_owner_name]; auto-match by first name when deal_owner_name unset (one match only; two Amits require admin to set)
- [x] Admin page: Role + Deal owner (data access) per user; edit and save; deal owners dropdown from current summary
- [x] Managers column removed from Team tab and filters; Manager filter removed from Intelligence dashboard
- [x] Agents list: reps see only their agent profile (by deal_owner_name)
- [x] Migration 008: users.deal_owner_name, dashboard_summary.summary_by_owner

## Completed — Alert delivery (Telegram, Discord, WhatsApp, Email)
- [x] Priority: Telegram, then Discord, then WhatsApp (Gupshup), then Email (Resend)
- [x] Config: TELEGRAM_BOT_TOKEN, gupshup_*, whatsapp_cloud_api_token (optional), resend_api_key
- [x] Migration 009: users.telegram_chat_id, notify_via_telegram/whatsapp/email; alert_delivery_log; telegram_link_tokens
- [x] Migration 010: users.discord_webhook_url, notify_via_discord; Discord webhook send (no bot token needed)
- [x] After CSV upload: save_alerts() then deliver_alerts_to_users() to each user's enabled channels
- [x] Alerts page: "Alert delivery" toggles (Telegram, WhatsApp, Email) + "Link Telegram" (t.me/Bot?start=TOKEN)
- [x] Telegram webhook: POST /api/alerts/telegram-webhook — set webhook URL in Telegram (setWebhook) so /start TOKEN links chat_id

## Research & automation
- [x] docs/RESEARCH_SALES_AUTOMATION_AND_DECISIONS.md: how to make team know what to do morning/afternoon/evening without meetings; manager decisions from lead data; prioritised build list
- [x] Daily pipeline: save briefs with brief_content + priority_list (was brief_text; DB expects brief_content)
- [x] Dashboard home: "Your next 3 things" from today's brief + agent next_best_action + Intelligence action_items (reps see their priorities first)

## Upcoming / Roadmap
- [ ] WhatsApp Business Cloud API (optional alternative to Gupshup)
- [ ] Zoho webhook integration: real-time lead updates
- [ ] Agent chat: sales reps can ask questions about their pipeline
- [ ] Preferences system: per-user dashboard customization
- [ ] Smart data management: deduplication on zoho_lead_id + lead_phone
- [ ] Connect with n8n for workflow automation

## CSV Columns (Zoho Export)
Key fields used: lead_name, deal_owner, lead_status, sale_done, sale_done_date,
annual_revenue (Rs. format), price_pitched (Rs. format), demo_done, demo_booked,
lead_source, state_mobile, region, user_date, last_touched_date_new, company_name,
sales_stage, is_prospect, lead_owner_manager, pre_qualification, Team_size,
user_profession, call_disposition, campaign_name, lead_notes, notes_date

## Supabase Credentials
- Project: jfuvhaampbngijfxgnnf
- URL: https://jfuvhaampbngijfxgnnf.supabase.co
- User: dhruv.tomar@onsiteteams.com

## GitHub
- Repo: aiagentwithdhruv/Onsite
- Branch: main
